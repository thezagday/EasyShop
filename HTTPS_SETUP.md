# HTTPS Setup Guide

## üîí –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π HTTPS —Å Caddy

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
–ò–Ω—Ç–µ—Ä–Ω–µ—Ç (HTTPS) 
    ‚Üì
Caddy :443 (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π SSL)
    ‚Üì 
Nginx :80 (–±–µ–∑ SSL, –≤–Ω—É—Ç—Ä–∏ Docker)
    ‚Üì
PHP :9000
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Caddy
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã** Let's Encrypt
- ‚úÖ **–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ (–∫–∞–∂–¥—ã–µ 90 –¥–Ω–µ–π)
- ‚úÖ **HTTP/2 –∏ HTTP/3** –∏–∑ –∫–æ—Ä–æ–±–∫–∏
- ‚úÖ **–ü—Ä–æ—Å—Ç–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** (–æ–¥–∏–Ω —Ñ–∞–π–ª)
- ‚úÖ **–ù–µ—Ç —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏** certbot/cron

---

## üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é

### 1. **DNS –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (—É —Ö–æ—Å—Ç–µ—Ä–∞)**
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ A-–∑–∞–ø–∏—Å–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã:
```
A    easy-shop.by           ‚Üí IP_–°–ï–†–í–ï–†–ê
A    www.easy-shop.by       ‚Üí IP_–°–ï–†–í–ï–†–ê  
A    admin.easy-shop.by     ‚Üí IP_–°–ï–†–í–ï–†–ê
```

### 2. **–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Ä—Ç—ã**
```bash
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ—Ä—Ç—ã 80 –∏ 443 –æ—Ç–∫—Ä—ã—Ç—ã
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ —Å–ª—É—à–∞–µ—Ç —ç—Ç–∏ –ø–æ—Ä—Ç—ã
sudo netstat -tlnp | grep ':80\|:443'
# –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª—É—à–∞–µ—Ç - –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, apache2/nginx –Ω–∞ —Ö–æ—Å—Ç–µ)
```

### 3. **–û–±–Ω–æ–≤–∏—Ç–µ .env**
```bash
# –í .env –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
MAIN_HOST=easy-shop.by
ADMIN_HOST=admin.easy-shop.by
APP_ENV=prod
```

### 4. **–†–∞–∑–≤–µ—Ä–Ω–∏—Ç–µ —Å HTTPS**
```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–µ–∫—É—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker compose -f docker-compose.prod.yml down

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å Caddy
docker compose -f docker-compose.prod.yml up -d

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Caddy
docker logs easyshop-caddy -f
```

**–í–∞–∂–Ω–æ**: Caddy –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∏—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ!

### 5. **–ü—Ä–æ–≤–µ—Ä–∫–∞**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ Caddy —Ä–∞–±–æ—Ç–∞–µ—Ç
curl -I https://easy-shop.by
# HTTP/2 200

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç —Å admin
curl -I https://admin.easy-shop.by
```

---

## üîß –ü—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞ 1: "acme: error presenting token"
**–ü—Ä–∏—á–∏–Ω–∞**: DNS –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ –ø–æ—Ä—Ç 80 –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω  
**–†–µ—à–µ–Ω–∏–µ**:
```bash
# 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ DNS
nslookup easy-shop.by

# 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ firewall
sudo ufw status

# 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Caddy
docker logs easyshop-caddy
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: "rate limit exceeded"
**–ü—Ä–∏—á–∏–Ω–∞**: –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç Let's Encrypt (5 —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –≤ –Ω–µ–¥–µ–ª—é)  
**–†–µ—à–µ–Ω–∏–µ**: –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–¥–µ–ª—é –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ staging:
```caddyfile
# –í Caddyfile –≤—Ä–µ–º–µ–Ω–Ω–æ –¥–æ–±–∞–≤—å—Ç–µ
{
    acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
}
```

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
**–ü—Ä–∏—á–∏–Ω–∞**: –û—à–∏–±–∫–∞ –≤ Caddyfile  
**–†–µ—à–µ–Ω–∏–µ**:
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
docker run --rm -v $(pwd)/Caddyfile:/etc/caddy/Caddyfile caddy:2-alpine caddy validate --config /etc/caddy/Caddyfile
```

---

## üîÑ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: Certbot + Nginx (—Å–ª–æ–∂–Ω–µ–µ)

–ï—Å–ª–∏ –Ω–µ —Ö–æ—Ç–∏—Ç–µ Caddy, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Ö–æ–¥:

### 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Certbot –Ω–∞ —Ö–æ—Å—Ç
```bash
sudo apt update
sudo apt install certbot python3-certbot-nginx
```

### 2. –ü–æ–ª—É—á–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
```bash
sudo certbot certonly --standalone \
  -d easy-shop.by \
  -d www.easy-shop.by \
  -d admin.easy-shop.by
```

### 3. –ü—Ä–∏–º–æ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –≤ Nginx
–í `docker-compose.prod.yml`:
```yaml
nginx:
  volumes:
    - /etc/letsencrypt:/etc/letsencrypt:ro
```

### 4. –û–±–Ω–æ–≤–∏—Ç–µ `default.conf`
```nginx
server {
    listen 443 ssl http2;
    ssl_certificate /etc/letsencrypt/live/easy-shop.by/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/easy-shop.by/privkey.pem;
    # ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
}
```

**‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ Certbot**:
- –ù—É–∂–µ–Ω cron –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- –°–ª–æ–∂–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- –ü—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã

---

## ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

**–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Caddy** ‚Äî —ç—Ç–æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è Docker-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º HTTPS!

---

## üìù Checklist

- [ ] DNS A-–∑–∞–ø–∏—Å–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [ ] –ü–æ—Ä—Ç—ã 80/443 –æ—Ç–∫—Ä—ã—Ç—ã –≤ firewall
- [ ] `.env` –æ–±–Ω–æ–≤–ª–µ–Ω (MAIN_HOST, ADMIN_HOST)
- [ ] `docker-compose.prod.yml` –æ–±–Ω–æ–≤–ª–µ–Ω (–¥–æ–±–∞–≤–ª–µ–Ω Caddy)
- [ ] `Caddyfile` —Å–æ–∑–¥–∞–Ω
- [ ] –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã
- [ ] HTTPS —Ä–∞–±–æ—Ç–∞–µ—Ç: `curl -I https://easy-shop.by`
- [ ] PWA —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç (—Ç—Ä–µ–±—É–µ—Ç HTTPS!)
